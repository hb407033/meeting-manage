generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                   String              @id @default(cuid())
  email                String              @unique
  name                 String
  password             String
  avatar               String?
  phone                String?
  isActive             Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  organizationId       String?
  authMethod           String              @default("LOCAL")
  lastLoginAt          DateTime?
  lastLoginIP          String?
  lockedUntil          DateTime?
  loginAttempts        Int                 @default(0)
  passwordResetExpires DateTime?
  passwordResetToken   String?             @unique
  organization         Organization?       @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  userRoles            UserRole[]
  reservations         Reservation[]
  auditLogs            AuditLog[]
  permissionRequests   PermissionRequest[]
  reviewedRequests     PermissionRequest[] @relation("RequestReviewer")
  roomHistory          RoomHistory[]
  recurringReservations RecurringReservation[] @relation("RecurringReservationOrganizer")
  meetingMaterials     MeetingMaterial[]

  @@map("users")
}

model Organization {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String?  @unique
  parentId  String?
  level     Int      @default(0)
  path      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]

  @@map("organizations")
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  code        String?          @unique
  description String?
  level       Int              @default(0)
  isSystem    Boolean          @default(false)
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  userRoles   UserRole[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  code        String?          @unique
  resource    String?
  action      String?
  description String?
  module      String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]

  @@map("permissions")
}

model UserRole {
  id         String    @id @default(cuid())
  userId     String
  roleId     String
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model MeetingRoom {
  id               String        @id @default(cuid())
  name             String
  description      String?
  capacity         Int
  location         String?
  equipment        Json?
  images           Json?
  status           RoomStatus    @default(AVAILABLE)
  rules            Json?
  requiresApproval Boolean       @default(false)
  deletedAt        DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  reservations     Reservation[]
  roomHistory      RoomHistory[]
  recurringReservations RecurringReservation[] @relation("RecurringReservationRoom")

  @@index([name])
  @@index([location])
  @@index([status])
  @@index([capacity])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("meeting_rooms")
}

model RoomHistory {
  id        String      @id @default(cuid())
  roomId    String
  action    String
  field     String?
  oldValue  Json?
  newValue  Json?
  userId    String?
  ipAddress String?
  userAgent String?
  timestamp DateTime    @default(now())
  room      MeetingRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("room_history")
}

model Reservation {
  id                      String              @id @default(cuid())
  title                   String
  description             String?
  startTime               DateTime
  endTime                 DateTime
  status                  ReservationStatus   @default(PENDING)
  organizerId             String
  attendeeCount           Int                 @default(1)
  roomId                  String
  recurringReservationId  String?             // 关联的周期性预约ID
  isException             Boolean             @default(false) // 是否为例外预约
  // 详细预约配置字段
  importanceLevel         ReservationImportance @default(NORMAL) // 会议重要性级别
  equipment               Json?               // 设备需求清单 [{"id": "projector", "quantity": 1, "name": "投影仪"}]
  services                Json?               // 服务需求配置 [{"id": "tea", "name": "茶水服务", "quantity": 10}]
  attendeeList            Json?               // 参会人员列表 [{"id": "user-1", "name": "张三", "type": "internal", "email": "zhang@company.com"}]
  // meetingMaterials 字段已移至关联的MeetingMaterial模型
  isRecurring             Boolean             @default(false) // 是否为重复预约
  recurringPattern        Json?               // rrule格式的重复模式
  specialRequirements     String?             // 特殊要求说明
  budgetAmount            Decimal?            @db.Decimal(10, 2) // 预算金额
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  organizer               User                @relation(fields: [organizerId], references: [id])
  room                    MeetingRoom         @relation(fields: [roomId], references: [id])
  recurringReservation    RecurringReservation? @relation("RecurringReservationInstances", fields: [recurringReservationId], references: [id])
  meetingMaterials        MeetingMaterial[]   // 关联的会议材料

  @@map("reservations")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

model PermissionRequest {
  id            String    @id @default(cuid())
  requestedBy   String
  permissions   Json
  roles         Json
  reason        String
  duration      String?
  urgency       String    @default("normal")
  attachments   Json?
  userAgent     String?
  requestPath   String?
  expiresAt     DateTime?
  status        String    @default("pending")
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewReason  String?
  reviewComment String?
  requestedAt   DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  requester     User      @relation(fields: [requestedBy], references: [id], onDelete: Cascade)
  reviewer      User?     @relation("RequestReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@map("permission_requests")
}

model AuditLog {
  id           String       @id @default(cuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime     @default(now())
  result       AuditResult? @default(SUCCESS)
  riskLevel    RiskLevel?   @default(LOW)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([resourceType, resourceId])
  @@index([riskLevel, timestamp])
  @@index([result, timestamp])
  @@index([ipAddress])
  @@index([timestamp])
  @@map("audit_logs")
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  RESERVED
  DISABLED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELED
  COMPLETED
}

enum ReservationImportance {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AuditResult {
  SUCCESS
  FAILURE
  PARTIAL
  ERROR
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// 周期性预约相关模型
model RecurringReservation {
  id                   String                       @id @default(cuid())
  title                String
  description          String?
  organizerId          String
  roomId               String
  startTime            DateTime
  endTime              DateTime
  recurrenceRule       String                       // RFC 5545 RRule字符串
  endCondition         RecurrenceEndCondition       @default(NEVER)
  endCount             Int?                          // 按次数结束时的次数
  endDate              DateTime?                     // 按日期结束时的结束日期
  bufferMinutes        Int                          @default(15)     // 缓冲时间（分钟）
  skipHolidays         Boolean                      @default(true)
  holidayRegion        String                       @default("CN")
  status               RecurringReservationStatus    @default(ACTIVE)
  maxOccurrences       Int?                          // 最大实例数量限制
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt

  // 关联关系
  organizer            User                         @relation("RecurringReservationOrganizer", fields: [organizerId], references: [id])
  room                 MeetingRoom                  @relation("RecurringReservationRoom", fields: [roomId], references: [id])
  reservations         Reservation[]                @relation("RecurringReservationInstances")
  exceptions           RecurringException[]

  @@map("recurring_reservations")
}

model RecurringException {
  id                    String                     @id @default(cuid())
  recurringReservationId String
  exceptionType         RecurringExceptionType     @default(CANCELLED)
  originalStartTime     DateTime
  originalEndTime       DateTime
  newStartTime          DateTime?
  newEndTime            DateTime?
  reason                String?
  createdBy             String?
  createdAt             DateTime                   @default(now())
  updatedAt             DateTime                   @updatedAt

  // 关联关系
  recurringReservation  RecurringReservation       @relation(fields: [recurringReservationId], references: [id], onDelete: Cascade)

  @@unique([recurringReservationId, originalStartTime])
  @@map("recurring_exceptions")
}

model Holiday {
  id        String    @id @default(cuid())
  date      DateTime  @unique
  name      String
  region    String    @default("CN")
  type      HolidayType @default(NATIONAL)
  isActive  Boolean   @default(true)
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([region, date])
  @@index([date])
  @@map("holidays")
}

model MeetingMaterial {
  id              String        @id @default(cuid())
  name            String        // 显示名称
  originalName    String        // 原始文件名
  type            String        // MIME类型
  size            Int           // 文件大小（字节）
  url             String        // 访问URL
  filePath        String        // 物理文件路径
  fileHash        String        // 文件MD5哈希值
  uploadedBy      String        // 上传者姓名
  userId          String        // 上传者用户ID
  reservationId   String?       // 关联的预约ID（可选）
  description     String?       // 文件描述
  isPublic        Boolean       @default(false) // 是否公开
  downloadCount   Int           @default(0) // 下载次数
  lastDownloadAt  DateTime?     // 最后下载时间
  deletedAt       DateTime?     // 软删除时间
  deletedBy       String?       // 删除者用户ID
  deletedReason   String?       // 删除原因
  uploadedAt      DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // 关联关系
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservation     Reservation?  @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([reservationId])
  @@index([type])
  @@index([uploadedAt])
  @@index([deletedAt])
  @@index([fileHash])
  @@unique([fileHash, userId]) // 同一用户不能上传相同文件
  @@map("meeting_materials")
}

enum RecurrenceEndCondition {
  NEVER    // 永不结束
  COUNT    // 按次数结束
  DATE     // 按日期结束
}

enum RecurringReservationStatus {
  ACTIVE     // 活跃状态
  PAUSED     // 暂停状态
  COMPLETED  // 已完成
  CANCELED   // 已取消
}

enum RecurringExceptionType {
  CANCELLED  // 取消该次预约
  MODIFIED   // 修改该次预约
  MOVED      // 移动该次预约到新时间
}

enum HolidayType {
  NATIONAL   // 国家法定节假日
  REGIONAL   // 地方性节假日
  CUSTOM     // 自定义节假日
}
