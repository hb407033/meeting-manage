generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                   String              @id @default(cuid())
  email                String              @unique
  name                 String
  password             String
  avatar               String?
  phone                String?
  isActive             Boolean             @default(true)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  organizationId       String?
  authMethod           String              @default("LOCAL")
  lastLoginAt          DateTime?
  lastLoginIP          String?
  lockedUntil          DateTime?
  loginAttempts        Int                 @default(0)
  passwordResetExpires DateTime?
  passwordResetToken   String?             @unique
  organization         Organization?       @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  userRoles            UserRole[]
  reservations         Reservation[]
  auditLogs            AuditLog[]
  permissionRequests   PermissionRequest[]
  reviewedRequests     PermissionRequest[] @relation("RequestReviewer")
  roomHistory          RoomHistory[]

  @@map("users")
}

model Organization {
  id        String   @id @default(cuid())
  name      String   @unique
  code      String?  @unique
  parentId  String?
  level     Int      @default(0)
  path      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]

  @@map("organizations")
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  code        String?          @unique
  description String?
  level       Int              @default(0)
  isSystem    Boolean          @default(false)
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  userRoles   UserRole[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  code        String?          @unique
  resource    String?
  action      String?
  description String?
  module      String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]

  @@map("permissions")
}

model UserRole {
  id         String    @id @default(cuid())
  userId     String
  roleId     String
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model MeetingRoom {
  id               String        @id @default(cuid())
  name             String
  description      String?
  capacity         Int
  location         String?
  equipment        Json?
  images           Json?
  status           RoomStatus    @default(AVAILABLE)
  rules            Json?
  requiresApproval Boolean       @default(false)
  deletedAt        DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  reservations     Reservation[]
  roomHistory      RoomHistory[]

  // 添加索引以优化搜索性能
  @@index([name])
  @@index([location])
  @@index([status])
  @@index([capacity])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("meeting_rooms")
}

model RoomHistory {
  id        String      @id @default(cuid())
  roomId    String
  action    String
  field     String?
  oldValue  Json?
  newValue  Json?
  userId    String?
  ipAddress String?
  userAgent String?
  timestamp DateTime    @default(now())
  room      MeetingRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("room_history")
}

model Reservation {
  id            String            @id @default(cuid())
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime
  status        ReservationStatus @default(PENDING)
  organizerId   String
  attendeeCount Int               @default(1)
  roomId        String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  organizer     User              @relation(fields: [organizerId], references: [id])
  room          MeetingRoom       @relation(fields: [roomId], references: [id])

  @@map("reservations")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

model PermissionRequest {
  id            String    @id @default(cuid())
  requestedBy   String
  permissions   Json
  roles         Json
  reason        String
  duration      String?
  urgency       String    @default("normal")
  attachments   Json?
  userAgent     String?
  requestPath   String?
  expiresAt     DateTime?
  status        String    @default("pending")
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewReason  String?
  reviewComment String?
  requestedAt   DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  requester     User      @relation(fields: [requestedBy], references: [id], onDelete: Cascade)
  reviewer      User?     @relation("RequestReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@map("permission_requests")
}

model AuditLog {
  id           String        @id @default(cuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  result       AuditResult?  @default(SUCCESS)
  riskLevel    RiskLevel?    @default(LOW)
  timestamp    DateTime      @default(now())
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  // 优化查询性能的索引
  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([resourceType, resourceId])
  @@index([riskLevel, timestamp])
  @@index([result, timestamp])
  @@index([ipAddress])
  @@index([timestamp])

  @@map("audit_logs")
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  RESERVED
  DISABLED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELED
  COMPLETED
}

enum AuditResult {
  SUCCESS
  FAILURE
  PARTIAL
  ERROR
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
