<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>operation-audit-log-system</title>
    <status>drafted</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/houbin/code/youtong/youtong2/meeting/meeting-manage/docs/sprint-artifacts/stories/1-4-operation-audit-log-system.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>系统管理员</asA>
    <iWant>记录和审计所有用户操作日志</iWant>
    <soThat>确保系统安全合规，提供操作追溯能力</soThat>
    <tasks>- [ ] Task 1.4.1: 设计审计日志数据模型和存储结构 (AC: 1, 2, 5)
  - [ ] 设计audit_logs表结构，包含所有必要字段
  - [ ] 实现日志数据的不可篡改机制
  - [ ] 创建日志索引优化查询性能
  - [ ] 设计日志分区策略，支持大量数据存储
  - [ ] 编写数据库迁移文件

- [ ] Task 1.4.2: 实现审计日志中间件和核心功能 (AC: 1, 2, 3)
  - [ ] 创建server/middleware/audit.ts审计中间件
  - [ ] 实现自动日志记录功能，覆盖所有API请求
  - [ ] 实现操作内容捕获和数据变更检测
  - [ ] 集成敏感操作标记和分类逻辑
  - [ ] 配置异步日志写入，避免影响主业务性能

- [ ] Task 1.4.3: 实现日志查询和管理API (AC: 6)
  - [ ] 创建server/api/v1/admin/audit-logs查询接口
  - [ ] 实现多维度筛选功能(时间、用户、操作类型)
  - [ ] 创建日志导出API，支持Excel、PDF、CSV格式
  - [ ] 实现分页查询和排序功能
  - [ ] 添加API权限检查和参数验证

- [ ] Task 1.4.4: 开发异常检测和告警系统 (AC: 4, 7)
  - [ ] 实现异常操作行为检测算法
  - [ ] 创建高风险操作告警机制
  - [ ] 实现实时监控和通知功能
  - [ ] 设计异常模式识别和统计功能
  - [ ] 创建管理员异常处理工作流

- [ ] Task 1.4.5: 创建审计日志管理前端界面 (AC: 6, 7)
  - [ ] 创建AuditLogViewer.vue审计日志查看界面
  - [ ] 实现LogFilter.vue日志筛选器组件
  - [ ] 设计LogExporter.vue日志导出功能组件
  - [ ] 建立RiskAlert.vue高风险操作告警组件
  - [ ] 实现LogAnalysis.vue日志分析仪表盘

- [ ] Task 1.4.6: 集成审计系统到现有组件 (AC: 3, 4)
  - [ ] 为所有现有API添加审计中间件
  - [ ] 实现敏感操作的二次确认对话框
  - [ ] 更新权限管理操作，添加审计标记
  - [ ] 配置系统级关键操作的自动告警
  - [ ] 编写集成测试和性能测试</tasks>
  </story>

  <acceptanceCriteria>1. **Given** 用户在系统中执行任何操作, **When** 操作完成时, **Then** 系统自动记录详细的操作日志
2. 记录用户ID、操作类型、操作时间、IP地址、操作结果
3. 记录操作的具体内容和相关数据变更
4. 敏感操作(如删除、权限变更)进行特殊标记和告警
5. 日志数据不可篡改，确保审计的完整性
6. 提供日志查询和导出功能，支持按时间、用户、操作类型筛选
7. 异常操作行为检测，识别潜在的安全威胁</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>产品需求文档</title>
        <section>FR4 - 系统记录和审计所有用户操作日志</section>
        <snippet>系统记录和审计所有用户操作日志，确保系统安全合规，提供操作追溯能力。安全审计包含操作日志记录、安全事件监控、异常行为检测和定期安全评估。</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>系统架构文档</title>
        <section>审计日志系统</section>
        <snippet>✅ 审计日志系统 - 项目已完成基础架构实施，包含审计日志工具 (server/utils/audit.ts)。基于Nuxt 4 + PrimeVue + FormKit技术栈，结合MySQL数据库、Redis缓存、Prisma ORM和完整的RBAC权限系统。</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic分解文档</title>
        <section>Story 1.4: 操作审计日志系统</section>
        <snippet>As a 系统管理员, I want 记录和审计所有用户操作日志, So that 确保系统安全合规，提供操作追溯能力。对应FR4: 系统记录和审计所有用户操作日志。</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1技术规范</title>
        <section>安全审计要求</section>
        <snippet>记录用户ID、操作类型、操作时间、IP地址、操作结果。记录操作的具体内容和相关数据变更。敏感操作特殊标记和告警。日志数据不可篡改，确保审计完整性。提供日志查询和导出功能，支持多维度筛选。异常操作行为检测，识别潜在安全威胁。</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-3-role-permission-management.md</path>
        <title>权限管理系统故事</title>
        <section>可复用组件</section>
        <snippet>完整的RBAC权限系统可用 - 使用hasPermission(), hasRole()函数进行权限验证。利用已有的Redis缓存配置优化审计日志查询性能。复用AdminLayout.vue布局组件创建审计管理界面。</snippet>
      </doc>
    </docs>
    <code>
      <code>
        <path>app/composables/usePermissions.ts</path>
        <kind>function</kind>
        <symbol>hasPermission</symbol>
        <lines>101-111</lines>
        <reason>核心权限验证函数，用于审计日志的访问控制</reason>
      </code>
      <code>
        <path>app/composables/usePermissionControl.ts</path>
        <kind>constant</kind>
        <symbol>AUDIT_LOG</symbol>
        <lines>319</lines>
        <reason>预定义的审计日志权限常量，用于权限管理</reason>
      </code>
      <code>
        <path>app/layouts/AdminLayout.vue</path>
        <kind>vue component</kind>
        <symbol>AdminLayout</symbol>
        <lines>109-115</lines>
        <reason>管理后台布局组件，包含审计日志导航链接</reason>
      </code>
      <code>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>Database Schema</symbol>
        <lines>1-30</lines>
        <reason>现有数据库架构，需要添加AuditLog模型</reason>
      </code>
      <code>
        <path>server/utils</path>
        <kind>directory</kind>
        <symbol>audit.ts</symbol>
        <lines>107</lines>
        <reason>审计日志工具文件已存在，需要实现具体功能</reason>
      </code>
      <code>
        <path>app/pages/admin/rooms/[id].vue</path>
        <kind>vue component</kind>
        <symbol>audit:read permission check</symbol>
        <lines>183-188</lines>
        <reason>现有页面中的审计权限检查示例，可复用模式</reason>
      </code>
    </code>
    <dependencies>
      <dependency ecosystem="node.js" name="nuxt" version="^4.0.0" />
      <dependency ecosystem="node.js" name="@prisma/client" version="^5.0.0" />
      <dependency ecosystem="node.js" name="redis" version="^4.6.0" />
      <dependency ecosystem="node.js" name="primevue" version="^4.0.0" />
      <dependency ecosystem="node.js" name="bcryptjs" version="^2.4.3" />
      <dependency ecosystem="node.js" name="jsonwebtoken" version="^9.0.0" />
      <dependency ecosystem="node.js" name="vitest" version="^1.0.0" />
      <dependency ecosystem="database" name="mysql" version="8.0+" />
    </dependencies>
  </artifacts>

  <constraints>
    - 技术栈：必须基于现有Nuxt 4 + Prisma + Redis架构
    - 权限控制：必须复用已建立的RBAC权限系统
    - 数据安全：日志数据不可篡改，使用只插入策略
    - 性能要求：日志写入异步处理，不影响主业务性能
    - 查询响应：普通查询&lt;200ms，复杂查询&lt;2s
    - 存储容量：支持每天10万+日志记录
    - 缓存策略：查询结果缓存5分钟，写入时立即失效
    - 代码规范：遵循现有的TypeScript严格模式和代码规范
    - 项目结构：遵循已建立的目录结构和命名规范
  </constraints>

  <interfaces>
    <interface name="hasPermission" kind="function" signature="async function hasPermission(userId: string, permission: string): Promise&lt;boolean&gt;" path="app/composables/usePermissions.ts" />
    <interface name="AuditLog API" kind="REST endpoints" signature="GET/POST /api/v1/admin/audit-logs" path="server/api/v1/admin/audit-logs" />
    <interface name="Audit Middleware" kind="middleware" signature="server/middleware/audit.ts" path="server/middleware/audit.ts" />
    <interface name="Permission Check" kind="vue component" signature="audit:read" path="app/composables/usePermissionControl.ts" />
  </interfaces>

  <tests>
    <standards>使用Vitest进行单元测试，API测试使用Supertest。测试覆盖率目标&gt;80%。遵循现有的测试架构和模式，包含单元测试、集成测试和端到端测试。</standards>
    <locations>
      - tests/unit/audit.test.ts - 审计功能单元测试
      - tests/integration/audit-logs.test.ts - 审计API集成测试
      - tests/e2e/audit-workflow.test.ts - 审计工作流端到端测试
    </locations>
    <ideas>
      - AC1: 测试自动日志记录功能 - 模拟用户操作验证日志生成
      - AC2: 验证日志字段完整性 - 检查用户ID、操作类型、时间、IP、结果等字段
      - AC3: 测试操作内容捕获 - 验证数据变更和操作内容的记录准确性
      - AC4: 测试敏感操作标记 - 验证删除、权限变更等操作的标记逻辑
      - AC5: 测试日志不可篡改性 - 验证只插入策略和防篡改机制
      - AC6: 测试日志查询导出功能 - 验证多维度筛选和导出格式
      - AC7: 测试异常检测算法 - 验证异常行为检测和告警机制
    </ideas>
  </tests>
</story-context>