<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>5</storyId>
    <title>å‘¨æœŸæ€§é¢„çº¦ç®¡ç†</title>
    <status>drafted</status>
    <generatedAt>2025-11-20T00:00:00Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/3-5-recurring-reservation-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>ä¼šè®®ç»„ç»‡è€…</asA>
    <iWant>åˆ›å»ºå’Œç®¡ç†å‘¨æœŸæ€§é¢„çº¦</iWant>
    <soThat>ç®€åŒ–é‡å¤ä¼šè®®çš„é¢„çº¦ç®¡ç†ï¼Œæé«˜å·¥ä½œæ•ˆç‡</soThat>
    <tasks>- [ ] Task 1: å‘¨æœŸæ€§é¢„çº¦æ•°æ®æ¨¡å‹è®¾è®¡ (AC: 1, 2, 3)
  - [ ] Subtask 1.1: æ‰©å±•Prisma schemaï¼Œåˆ›å»ºrecurring_reservationsè¡¨
  - [ ] Subtask 1.2: è®¾è®¡rruleè§„åˆ™å­˜å‚¨ç»“æ„ï¼Œæ”¯æŒRFC 5545æ ‡å‡†
  - [ ] Subtask 1.3: åˆ›å»ºrecurring_exceptionsè¡¨å¤„ç†ç‰¹æ®Šæ—¥æœŸå’Œä¾‹å¤–
  - [ ] Subtask 1.4: å®ç°æ•°æ®è¿ç§»è„šæœ¬ï¼Œå…¼å®¹ç°æœ‰é¢„çº¦æ•°æ®

- [ ] Task 2: é‡å¤é¢„çº¦ç®—æ³•å¼•æ“ (AC: 1, 2, 3)
  - [ ] Subtask 2.1: åˆ›å»ºRecurringReservationEngineæœåŠ¡ç±»
  - [ ] Subtask 2.2: å®ç°rruleè§£æå™¨ï¼Œæ”¯æŒå¤šç§é‡å¤æ¨¡å¼
  - [ ] Subtask 2.3: å¼€å‘æ—¥æœŸåºåˆ—ç”Ÿæˆç®—æ³•ï¼Œå¤„ç†ç»“æŸæ¡ä»¶
  - [ ] Subtask 2.4: å®ç°èŠ‚å‡æ—¥å’Œç‰¹æ®Šæ—¥æœŸçš„è·³è¿‡é€»è¾‘
  - [ ] Subtask 2.5: ä¼˜åŒ–æ€§èƒ½ï¼Œæ”¯æŒå¤§æ—¶é—´èŒƒå›´çš„é¢„çº¦ç”Ÿæˆ

- [ ] Task 3: é¢„çº¦åºåˆ—ç®¡ç†åŠŸèƒ½ (AC: 4, 5)
  - [ ] Subtask 3.1: å®ç°å•æ¬¡é¢„çº¦ä¿®æ”¹åŠŸèƒ½ï¼Œä¸å½±å“åºåˆ—å…¶ä»–é¢„çº¦
  - [ ] Subtask 3.2: å¼€å‘æ‰¹é‡æ“ä½œæ¥å£ï¼Œæ”¯æŒæ•´ä¸ªåºåˆ—ä¿®æ”¹
  - [ ] Subtask 3.3: åˆ›å»ºé¢„çº¦åºåˆ—çŠ¶æ€ç®¡ç†ï¼Œè·Ÿè¸ªå˜æ›´å†å²
  - [ ] Subtask 3.4: å®ç°é¢„çº¦åºåˆ—çš„æš‚åœå’Œæ¢å¤åŠŸèƒ½
  - [ ] Subtask 3.5: æ”¯æŒé¢„çº¦åºåˆ—çš„æå‰ç»ˆæ­¢å’Œå»¶å±•

- [ ] Task 4: å†²çªæ£€æµ‹ä¸è§£å†³ (AC: 6)
  - [ ] Subtask 4.1: é›†æˆç°æœ‰ConflictDetectionEngineï¼Œæ‰©å±•æ”¯æŒå‘¨æœŸæ€§é¢„çº¦
  - [ ] Subtask 4.2: å®ç°æ‰¹é‡å†²çªæ£€æµ‹ç®—æ³•ï¼Œæ£€æŸ¥æ•´ä¸ªé¢„çº¦åºåˆ—
  - [ ] Subtask 4.3: å¼€å‘æ™ºèƒ½å†²çªè§£å†³ç­–ç•¥ï¼Œè‡ªåŠ¨è°ƒæ•´å†²çªé¢„çº¦
  - [ ] Subtask 4.4: åˆ›å»ºå†²çªå¤„ç†ç”¨æˆ·ç•Œé¢ï¼Œæä¾›æ‰‹åŠ¨è§£å†³é€‰é¡¹
  - [ ] Subtask 4.5: å®ç°å†²çªé¢„é˜²æœºåˆ¶ï¼Œåœ¨åˆ›å»ºæ—¶é¢„ä¼°æ½œåœ¨å†²çª

- [ ] Task 5: å‘¨æœŸæ€§é¢„çº¦APIå¼€å‘ (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Subtask 5.1: åˆ›å»º POST /api/v1/reservations/recurring åˆ›å»ºå‘¨æœŸæ€§é¢„çº¦æ¥å£
  - [ ] Subtask 5.2: å®ç° GET /api/v1/reservations/recurring/{id} æŸ¥è¯¢å‘¨æœŸæ€§é¢„çº¦æ¥å£
  - [ ] Subtask 5.3: å¼€å‘ PUT /api/v1/reservations/recurring/{id} æ›´æ–°å‘¨æœŸæ€§é¢„çº¦æ¥å£
  - [ ] Subtask 5.4: åˆ›å»º DELETE /api/v1/reservations/recurring/{id} åˆ é™¤å‘¨æœŸæ€§é¢„çº¦æ¥å£
  - [ ] Subtask 5.5: å®ç° POST /api/v1/reservations/recurring/{id}/conflict-check æ‰¹é‡å†²çªæ£€æŸ¥æ¥å£
  - [ ] Subtask 5.6: å¼€å‘ GET /api/v1/reservations/recurring/{id}/occurrences è·å–é¢„çº¦å®ä¾‹åˆ—è¡¨æ¥å£

- [ ] Task 6: å‘¨æœŸæ€§é¢„çº¦å‰ç«¯ç»„ä»¶ (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 6.1: åˆ›å»º RecurringReservationWizard.vue å‘¨æœŸæ€§é¢„çº¦å‘å¯¼
  - [ ] Subtask 6.2: å®ç° RecurrencePatternSelector.vue é‡å¤æ¨¡å¼é€‰æ‹©å™¨
  - [ ] Subtask 6.3: è®¾è®¡ EndConditionSelector.vue ç»“æŸæ¡ä»¶é€‰æ‹©å™¨
  - [ ] Subtask 6.4: å»ºç«‹ ExceptionDateManager.vue ä¾‹å¤–æ—¥æœŸç®¡ç†å™¨
  - [ ] Subtask 6.5: å¼€å‘ RecurringReservationList.vue é¢„çº¦åºåˆ—ç®¡ç†ç•Œé¢
  - [ ] Subtask 6.6: å®ç° BatchOperationPanel.vue æ‰¹é‡æ“ä½œé¢æ¿
  - [ ] Subtask 6.7: åˆ›å»º ConflictResolutionWizard.vue å‘¨æœŸæ€§é¢„çº¦å†²çªè§£å†³å‘å¯¼

- [ ] Task 7: æé†’é€šçŸ¥é›†æˆ (AC: 7)
  - [ ] Subtask 7.1: æ‰©å±•ç°æœ‰é€šçŸ¥ç³»ç»Ÿï¼Œæ”¯æŒå‘¨æœŸæ€§é¢„çº¦æé†’
  - [ ] Subtask 7.2: å®ç°ä¸ªæ€§åŒ–æé†’æ—¶é—´è®¾ç½®åŠŸèƒ½
  - [ ] Subtask 7.3: å¼€å‘æé†’é¢„è§ˆåŠŸèƒ½ï¼Œæ˜¾ç¤ºæœªæ¥æé†’è®¡åˆ’
  - [ ] Subtask 7.4: é›†æˆé‚®ä»¶å’Œç³»ç»Ÿå†…é€šçŸ¥åŒæ¸ é“æé†’
  - [ ] Subtask 7.5: å®ç°æé†’ç»Ÿè®¡åˆ†æï¼Œç›‘æ§æé†’æ•ˆæœ

- [ ] Task 8: æµ‹è¯•ä¸è´¨é‡ä¿è¯ (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Subtask 8.1: ç¼–å†™å‘¨æœŸæ€§é¢„çº¦å¼•æ“å•å…ƒæµ‹è¯•
  - [ ] Subtask 8.2: åˆ›å»ºAPIæ¥å£é›†æˆæµ‹è¯•
  - [ ] Subtask 8.3: å¼€å‘å‰ç«¯ç»„ä»¶æµ‹è¯•ï¼Œè¦†ç›–æ‰€æœ‰äº¤äº’åœºæ™¯
  - [ ] Subtask 8.4: å®ç°æ€§èƒ½æµ‹è¯•ï¼Œç¡®ä¿å¤§è§„æ¨¡é¢„çº¦åºåˆ—å¤„ç†æ•ˆç‡
  - [ ] Subtask 8.5: è¿›è¡Œè¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µæµ‹è¯•</tasks>
  </story>

  <acceptanceCriteria>1. å¤šç§é‡å¤æ¨¡å¼ï¼šæ”¯æŒæ¯æ—¥ã€æ¯å‘¨ã€æ¯æœˆã€è‡ªå®šä¹‰é—´éš”å››ç§é‡å¤æ¨¡å¼
2. çµæ´»çš„ç»“æŸæ¡ä»¶ï¼šæä¾›æŒ‰æ¬¡æ•°ç»“æŸã€æŒ‰æ—¥æœŸç»“æŸã€æ— é™åˆ¶ä¸‰ç§ç»“æŸæ¡ä»¶
3. ç‰¹æ®Šæ—¥æœŸå¤„ç†ï¼šè·³è¿‡èŠ‚å‡æ—¥ã€ç‰¹æ®Šæ—¥æœŸè°ƒæ•´ï¼Œæ”¯æŒè‡ªå®šä¹‰ä¾‹å¤–æ—¥æœŸ
4. å•æ¬¡ä¿®æ”¹åŠŸèƒ½ï¼šæ”¯æŒä¿®æ”¹å•æ¬¡é¢„çº¦è€Œä¸å½±å“æ•´ä¸ªåºåˆ—çš„ç‹¬ç«‹æ€§
5. æ‰¹é‡æ“ä½œï¼šæä¾›ä¿®æ”¹æ•´ä¸ªåºåˆ—ã€åˆ é™¤å¤šä¸ªé¢„çº¦çš„æ‰¹é‡ç®¡ç†åŠŸèƒ½
6. å†²çªæ™ºèƒ½å¤„ç†ï¼šè‡ªåŠ¨æ£€æµ‹å’Œè§£å†³é‡å¤é¢„çº¦çš„æ—¶é—´å†²çª
7. æé†’é€šçŸ¥ï¼šæ¯æ¬¡ä¼šè®®å‰çš„è‡ªåŠ¨æé†’è®¾ç½®ï¼Œæ”¯æŒä¸ªæ€§åŒ–æé†’æ—¶é—´</acceptanceCriteria>

  <artifacts>
    <docs>- path: docs/PRD.md
  title: Product Requirements Document - æ™ºèƒ½ä¼šè®®å®¤ç®¡ç†ç³»ç»Ÿ
  section: Functional Requirements - FR14: æ”¯æŒå‘¨æœŸæ€§é¢„çº¦çš„åˆ›å»ºå’Œç®¡ç†
  snippet: "FR14: æ”¯æŒå‘¨æœŸæ€§é¢„çº¦çš„åˆ›å»ºå’Œç®¡ç† - ç³»ç»Ÿåº”æ”¯æŒç”¨æˆ·åˆ›å»ºå‘¨æœŸæ€§é¢„çº¦ï¼ŒåŒ…æ‹¬æ¯æ—¥ã€æ¯å‘¨ã€æ¯æœˆé‡å¤æ¨¡å¼ï¼Œå¹¶æä¾›çµæ´»çš„ç»“æŸæ¡ä»¶è®¾ç½®ã€‚"

- path: docs/epics.md
  title: Epic Breakdown - Epic 3: é¢„çº¦ç³»ç»Ÿæ ¸å¿ƒ
  section: Story 3.5: å‘¨æœŸæ€§é¢„çº¦ç®¡ç†
  snippet: "As a ä¼šè®®ç»„ç»‡è€…, I want åˆ›å»ºå’Œç®¡ç†å‘¨æœŸæ€§é¢„çº¦, so that ç®€åŒ–é‡å¤ä¼šè®®çš„é¢„çº¦ç®¡ç†ï¼Œæé«˜å·¥ä½œæ•ˆç‡."

- path: docs/architecture.md
  title: Architecture Decision Document
  section: Epic to Architecture Mapping - Epic 3: é¢„çº¦ç³»ç»Ÿæ ¸å¿ƒ
  snippet: "Epic 3 (é¢„çº¦ç³»ç»Ÿæ ¸å¿ƒ) - é¢„çº¦æ•°æ®æ¨¡å‹ã€å†²çªæ£€æµ‹ã€çŠ¶æ€ç®¡ç†ã€æ—¥å†è§†å›¾ - ğŸš§ To Be Implemented"</docs>
    <code>- path: prisma/schema.prisma
  kind: database schema
  symbol: Reservation model
  lines: 160-176
  reason: ç°æœ‰çš„é¢„çº¦æ•°æ®æ¨¡å‹ï¼Œéœ€è¦æ‰©å±•ä»¥æ”¯æŒå‘¨æœŸæ€§é¢„çº¦åŠŸèƒ½

- path: server/api/v1/reservations/conflict-check.post.ts
  kind: API endpoint
  symbol: conflict detection API
  lines: 1-132
  reason: ç°æœ‰çš„å†²çªæ£€æµ‹APIï¼Œéœ€è¦æ‰©å±•ä»¥æ”¯æŒå‘¨æœŸæ€§é¢„çº¦çš„æ‰¹é‡å†²çªæ£€æµ‹

- path: server/services/conflict-detection.ts
  kind: service class
  symbol: ConflictDetectionEngine
  lines: 57-498
  reason: ç°æœ‰çš„å†²çªæ£€æµ‹å¼•æ“ï¼Œå¯ä»¥ä½œä¸ºå‘¨æœŸæ€§é¢„çº¦å†²çªæ£€æµ‹çš„åŸºç¡€

- path: package.json
  kind: dependency manifest
  symbol: rrule package
  lines: 57
  reason: é¡¹ç›®å·²åŒ…å«rruleåº“ï¼Œç”¨äºå¤„ç†é‡å¤è§„åˆ™ï¼Œè¿™æ˜¯å®ç°å‘¨æœŸæ€§é¢„çº¦çš„å…³é”®ä¾èµ–</code>
    <dependencies>- ecosystem: node.js
  packages:
    - name: rrule
      version: ^2.8.1
      purpose: RFC 5545æ ‡å‡†çš„é‡å¤è§„åˆ™å¤„ç†åº“ï¼Œç”¨äºå®ç°å‘¨æœŸæ€§é¢„çº¦ç®—æ³•
    - name: date-fns
      version: ^4.1.0
      purpose: ç°ä»£åŒ–æ—¥æœŸå¤„ç†åº“ï¼Œç”¨äºæ—¥æœŸè®¡ç®—å’Œæ ¼å¼åŒ–
    - name: @prisma/client
      version: ^6.19.0
      purpose: ç±»å‹å®‰å…¨çš„æ•°æ®åº“ORMï¼Œç”¨äºæ•°æ®æŒä¹…åŒ–
    - name: zod
      version: ^4.1.12
      purpose: TypeScriptä¼˜å…ˆçš„æ•°æ®éªŒè¯åº“ï¼Œç”¨äºAPIå‚æ•°éªŒè¯
    - name: ioredis
      version: ^5.8.2
      purpose: Rediså®¢æˆ·ç«¯ï¼Œç”¨äºç¼“å­˜å‘¨æœŸæ€§é¢„çº¦æ•°æ®</dependencies>
  </artifacts>

  <constraints>- æ‰©å±•ç°æœ‰Reservationæ¨¡å‹ï¼Œåˆ›å»ºRecurringReservationå’ŒRecurringExceptionå…³è”è¡¨
- å¤ç”¨ç°æœ‰ConflictDetectionEngineï¼Œæ‰©å±•æ”¯æŒå‘¨æœŸæ€§é¢„çº¦æ‰¹é‡å†²çªæ£€æµ‹
- éµå¾ªç°æœ‰APIå“åº”æ ¼å¼ï¼Œä¿æŒé”™è¯¯å¤„ç†ä¸€è‡´æ€§
- åˆ©ç”¨Redisç¼“å­˜ä¼˜åŒ–å¤§é‡é¢„çº¦å®ä¾‹çš„æŸ¥è¯¢æ€§èƒ½
- å®ç°å»¶è¿Ÿç”Ÿæˆç­–ç•¥ï¼Œé¿å…ä¸€æ¬¡æ€§åˆ›å»ºå¤§é‡é¢„çº¦å®ä¾‹
- ç¬¦åˆä¼ä¸šçº§å®‰å…¨è¦æ±‚ï¼Œæ“ä½œè®°å½•åˆ°å®¡è®¡æ—¥å¿—
- éµå¾ªç»Ÿä¸€çš„é¡¹ç›®ç»“æ„å’Œå‘½åè§„èŒƒ</constraints>
  <interfaces>- name: RecurringReservationService
  kind: service class
  signature: class RecurringReservationService { createRecurringReservation(data: CreateRecurringReservationRequest): Promise<RecurringReservation>; generateOccurrences(recurringId: string, startDate: Date, endDate: Date): Promise<Reservation[]>; updateSingleOccurrence(recurringId: string, occurrenceId: string, data: UpdateOccurrenceRequest): Promise<Reservation>; }
  path: server/services/recurring-reservation.ts

- name: POST /api/v1/reservations/recurring
  kind: REST endpoint
  signature: POST /api/v1/reservations/recurring - åˆ›å»ºå‘¨æœŸæ€§é¢„çº¦
  path: server/api/v1/reservations/recurring/index.post.ts

- name: RecurringReservationEngine
  kind: utility class
  signature: class RecurringReservationEngine { parseRRule(rule: string): RRuleOptions; generateDateSeries(options: RRuleOptions, constraints: DateConstraints): Date[]; skipHolidays(dates: Date[], holidays: Date[]): Date[]; }
  path: server/utils/recurring-engine.ts</interfaces>
  <tests>
    <standards>é¡¹ç›®ä½¿ç”¨Vitestä½œä¸ºæµ‹è¯•æ¡†æ¶ï¼Œé‡‡ç”¨TDDå¼€å‘æ¨¡å¼ã€‚æµ‹è¯•è¦†ç›–ç‡è¦æ±‚>90%ï¼Œé‡ç‚¹æµ‹è¯•å‘¨æœŸæ€§é¢„çº¦ç®—æ³•ã€å†²çªæ£€æµ‹é€»è¾‘å’Œè¾¹ç•Œæ¡ä»¶ã€‚æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä½äºtests/ç›®å½•ï¼Œéµå¾ª.test.tså‘½åè§„èŒƒã€‚</standards>
    <locations>- tests/unit/services/recurring-reservation.test.ts - å‘¨æœŸæ€§é¢„çº¦æœåŠ¡å•å…ƒæµ‹è¯•
- tests/unit/utils/recurring-engine.test.ts - é‡å¤è§„åˆ™å¼•æ“æµ‹è¯•
- tests/integration/api/recurring-reservation.test.ts - APIæ¥å£é›†æˆæµ‹è¯•
- tests/components/recurring-reservation.test.ts - å‰ç«¯ç»„ä»¶æµ‹è¯•</locations>
    <ideas>- AC1: æµ‹è¯•å¤šç§é‡å¤æ¨¡å¼çš„æ—¥æœŸåºåˆ—ç”Ÿæˆå‡†ç¡®æ€§
- AC2: éªŒè¯ä¸åŒç»“æŸæ¡ä»¶ä¸‹çš„é¢„çº¦å®ä¾‹æ•°é‡é™åˆ¶
- AC3: æµ‹è¯•èŠ‚å‡æ—¥è·³è¿‡å’Œä¾‹å¤–æ—¥æœŸå¤„ç†é€»è¾‘
- AC4: éªŒè¯å•æ¬¡ä¿®æ”¹ä¸å½±å“åºåˆ—å…¶ä»–é¢„çº¦çš„ç‹¬ç«‹æ€§
- AC5: æµ‹è¯•æ‰¹é‡æ“ä½œçš„äº‹åŠ¡ä¸€è‡´æ€§å’Œå›æ»šæœºåˆ¶
- AC6: éªŒè¯å¤§è§„æ¨¡é¢„çº¦åºåˆ—çš„å†²çªæ£€æµ‹æ€§èƒ½
- AC7: æµ‹è¯•æé†’é€šçŸ¥çš„æ—¶é—´å‡†ç¡®æ€§å’Œä¸ªæ€§åŒ–è®¾ç½®</ideas>
  </tests>
</story-context>