<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>会议室基础数据管理</title>
    <status>done</status>
    <generatedAt>2025-11-17T12:00:00.000Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/stories/2-1-room-basic-data-management.md</sourceStoryPath>
    <lastUpdated>2025-11-17 - Complete implementation with advanced optimization guidance</lastUpdated>
  </metadata>

  <story>
    <asA>系统管理员</asA>
    <iWant>添加、编辑和删除会议室基础信息</iWant>
    <soThat>建立完整的会议室资源数据库</soThat>
    <tasks>Task 2.1.1: 设计和实现会议室数据模型 ✅ COMPLETED
Task 2.1.2: 实现会议室管理API接口 ✅ COMPLETED
Task 2.1.3: 实现文件上传和管理功能 ✅ COMPLETED
Task 2.1.4: 创建会议室管理前端组件 ✅ COMPLETED
Task 2.1.5: 实现会议室状态管理 ✅ COMPLETED
Task 2.1.6: 实现批量操作功能 ✅ COMPLETED
Task 2.1.7: 实现会议室操作历史记录 ✅ COMPLETED
Task 2.1.8: 实现缓存和性能优化 ⚠️ INCOMPLETE (Redis缓存未实现)
Task 2.1.9: 添加安全验证和权限控制 ✅ COMPLETED</tasks>
  </story>

  <acceptanceCriteria>1. **Given** 管理员已登录系统
**When** 管理员进行会议室信息管理操作
**Then** 系统提供完整的会议室基础信息管理功能

**And** 会议室信息包含：名称、位置、容量、设施配置、描述等基础字段
**And** 支持会议室的多媒体内容管理，包括照片、360度全景图、视频介绍
**And** 表单验证机制完善，确保数据完整性和格式正确性
**And** 批量操作支持，允许同时导入/导出会议室信息
**And** 会议室状态管理：可用、维护中、禁用等状态切换
**And** 操作确认机制，防止误删除重要数据
**And** 变更历史记录，跟踪会议室信息修改历史</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="技术架构文档" section="Core Data Models" snippet="MeetingRoom 数据模型定义包含基础字段：name, location, capacity, description，设备配置equipment (JSON)，图片管理images (JSON)，状态管理status (枚举)，规则配置rules (JSON)，软删除支持deletedAt" />
      <doc path="docs/architecture.md" title="技术架构文档" section="API Contracts" snippet="RESTful API 设计规范，使用统一响应格式 {success, data, message, timestamp}，标准HTTP状态码，分页响应格式，错误响应格式" />
      <doc path="docs/architecture.md" title="技术架构文档" section="Security Architecture" snippet="JWT + RBAC权限模型，用户角色分为ADMIN, ENTERPRISE_ADMIN, USER，权限粒度到具体功能操作" />
      <doc path="docs/architecture.md" title="技术架构文档" section="缓存策略模式" snippet="多层缓存架构：浏览器缓存(1小时)，内存缓存(10分钟)，Redis缓存(10分钟)，缓存失效策略" />
      <doc path="docs/architecture.md" title="技术架构文档" section="Implementation Patterns" snippet="Nuxt 4 + PrimeVue + Prisma + MySQL 技术栈，使用Pinia状态管理，FormKit表单验证，TypeScript严格检查" />
      <doc path="docs/PRD.md" title="产品需求文档" section="FR6-FR10 会议室管理" snippet="FR6: 会议室信息管理，FR7: 会议室状态管理，FR8: 会议室搜索过滤，FR9: 会议室详情展示，FR10: 会议室规则配置" />
      <doc path="docs/ux-design-specification.md" title="UX设计规范" section="设计系统" snippet="PrimeVue Styled Mode + Aura主题 + 企业定制，企业商务蓝主色调，简洁专业的商务风格" />
      <doc path="docs/ux-design-specification.md" title="UX设计规范" section="核心体验" snippet="预约会议室，从未如此简单 - 一目了然的状态展示 + 极其简单的操作流程" />
      <doc path="docs/epics.md" title="Epic分解文档" section="Epic 2 会议室核心管理" snippet="包含4个Story：2.1会议室基础数据管理，2.2会议室搜索和过滤，2.3会议室详情展示，2.4会议室规则配置" />
      <doc path="docs/sprint-artifacts/tech-spec-epic-1.md" title="Epic 1技术规格" section="基础设施状态" snippet="Docker基础设施重组已完成，开发环境稳定可用，Nuxt 4 + PrimeVue + MySQL + Redis环境就绪" />
    </docs>
    <code>
      <!-- 数据模型 -->
      <code path="prisma/schema.prisma" kind="database-model" symbol="MeetingRoom" lines="139-171" reason="✅ 已实现核心会议室数据模型，包含基础字段、设备配置、状态管理、软删除支持" />
      <code path="prisma/schema.prisma" kind="database-model" symbol="RoomStatus" lines="177-183" reason="✅ 已实现会议室状态枚举：AVAILABLE, OCCUPIED, MAINTENANCE, DISABLED" />
      <code path="prisma/schema.prisma" kind="database-model" symbol="RoomHistory" lines="185-200" reason="✅ 已实现会议室操作历史记录模型" />

      <!-- 会议室管理API - 全部已实现并修复安全漏洞 -->
      <code path="server/api/v1/rooms/index.get.ts" kind="api-endpoint" symbol="GET /api/v1/rooms" lines="1-125" reason="✅ 已实现获取会议室列表API + JWT认证 + room:read权限" />
      <code path="server/api/v1/rooms/index.post.ts" kind="api-endpoint" symbol="POST /api/v1/rooms" lines="1-74" reason="✅ 已实现创建会议室API + JWT认证 + room:create权限 + 用户ID记录" />
      <code path="server/api/v1/rooms/[id].get.ts" kind="api-endpoint" symbol="GET /api/v1/rooms/:id" lines="1-73" reason="✅ 已实现获取会议室详情API + JWT认证 + room:read权限" />
      <code path="server/api/v1/rooms/[id].put.ts" kind="api-endpoint" symbol="PUT /api/v1/rooms/:id" lines="1-104" reason="✅ 已实现更新会议室API + JWT认证 + room:update权限 + 用户ID记录" />
      <code path="server/api/v1/rooms/[id].delete.ts" kind="api-endpoint" symbol="DELETE /api/v1/rooms/:id" lines="1-86" reason="✅ 已实现删除会议室API + JWT认证 + room:delete权限 + 用户ID记录" />

      <!-- 文件上传API - 已实现并修复安全漏洞 -->
      <code path="server/api/v1/upload/rooms/post.ts" kind="api-endpoint" symbol="POST /api/v1/upload/rooms" lines="1-145" reason="✅ 已实现会议室图片上传API + JWT认证 + room:update权限 + 用户ID记录" />

      <!-- 批量操作API - 已完成实现 -->
      <code path="server/api/v1/rooms/import.post.ts" kind="api-endpoint" symbol="POST /api/v1/rooms/import" lines="1-60" reason="✅ 已实现CSV批量导入API + 数据验证 + 错误处理 + 操作日志" />
      <code path="server/api/v1/rooms/export.get.ts" kind="api-endpoint" symbol="GET /api/v1/rooms/export" lines="1-40" reason="✅ 已实现CSV导出API + 筛选支持 + 格式化下载" />
      <code path="server/api/v1/rooms/template.get.ts" kind="api-endpoint" symbol="GET /api/v1/rooms/template" lines="1-30" reason="✅ 已实现CSV模板下载API + 标准格式模板" />
      <code path="server/api/v1/rooms/import/preview.post.ts" kind="api-endpoint" symbol="POST /api/v1/rooms/import/preview" lines="1-50" reason="✅ 已实现CSV预览API + 数据验证 + 错误检查" />

      <!-- 历史记录API - 已完成实现 -->
      <code path="server/api/v1/rooms/history.get.ts" kind="api-endpoint" symbol="GET /api/v1/rooms/:id/history" lines="1-40" reason="✅ 已实现会议室历史记录API + 操作审计 + 变更追踪" />

      <!-- CSV处理工具 -->
      <code path="server/utils/csv.ts" kind="utility" symbol="CSV处理工具" lines="1-120" reason="✅ 已实现CSV解析、验证、生成工具，支持批量导入导出功能" />

      <!-- 数据验证Schema -->
      <code path="server/schemas/room.ts" kind="validation-schema" symbol="RoomQuerySchema" lines="1-50" reason="会议室查询参数验证schema" />
      <code path="server/schemas/room.ts" kind="validation-schema" symbol="CreateRoomSchema" lines="50-100" reason="创建会议室数据验证schema" />
      <code path="server/schemas/room.ts" kind="validation-schema" symbol="UpdateRoomSchema" lines="100-150" reason="更新会议室数据验证schema" />

      <!-- 权限中间件 -->
      <code path="server/middleware/permission.ts" kind="middleware" symbol="requirePermission" lines="161-172" reason="权限检查中间件，用于会议室管理权限验证 - 已集成到所有API" />

      <!-- 前端组件 -->
      <code path="app/components/features/rooms/RoomManagement.vue" kind="vue-component" symbol="RoomManagement" lines="1-200" reason="✅ 已实现会议室管理主界面" />
      <code path="app/components/features/rooms/RoomCard.vue" kind="vue-component" symbol="RoomCard" lines="1-100" reason="✅ 已实现会议室卡片组件" />
      <code path="app/components/features/rooms/RoomForm.vue" kind="vue-component" symbol="RoomForm" lines="1-150" reason="✅ 已实现会议室编辑表单组件" />
      <code path="app/components/features/rooms/RoomBatchImport.vue" kind="vue-component" symbol="RoomBatchImport" lines="1-180" reason="✅ 已实现批量导入组件，支持4步导入流程" />
      <code path="app/components/features/rooms/RoomDetail.vue" kind="vue-component" symbol="RoomDetail" lines="1-120" reason="✅ 已实现会议室详情展示组件" />
      <code path="app/components/features/rooms/RoomHistoryView.vue" kind="vue-component" symbol="RoomHistoryView" lines="1-120" reason="✅ 已实现历史记录查看组件，支持时间线展示" />

      <!-- 状态管理 -->
      <code path="app/stores/rooms.ts" kind="pinia-store" symbol="useRoomsStore" lines="1-100" reason="✅ 已实现会议室状态管理" />
      <code path="app/composables/useRooms.ts" kind="composable" symbol="useRooms" lines="1-80" reason="✅ 已实现会议室相关组合式函数，提供复用的业务逻辑" />

      <!-- API工具 -->
      <code path="server/utils/response.ts" kind="utility" symbol="createSuccessResponse" lines="1-50" reason="统一成功响应格式 - 已在所有API中使用" />
      <code path="server/utils/response.ts" kind="utility" symbol="createErrorResponse" lines="50-100" reason="统一错误响应格式 - 已在所有API中使用" />

      <!-- Redis缓存服务 -->
      <code path="server/services/redis.ts" kind="service" symbol="Redis缓存服务" lines="1-150" reason="✅ 已配置Redis连接和缓存操作，支持分布式锁、限流等高级功能" />
    </code>
    <dependencies>
      <framework ecosystem="Node.js">
        <package name="nuxt" version="^4.2.1" reason="前端框架 - Vue 3 全栈框架" />
        <package name="vue" version="^3.5.24" reason="核心Vue框架" />
        <package name="vue-router" version="^4.6.3" reason="路由管理" />
        <package name="primevue" version="^4.4.1" reason="UI组件库 - 企业级组件" />
        <package name="@primevue/themes" version="^4.4.1" reason="PrimeVue主题系统" />
        <package name="@prisma/client" version="^6.19.0" reason="数据库ORM客户端" />
        <package name="jsonwebtoken" version="^9.0.2" reason="JWT认证" />
        <package name="bcryptjs" version="^3.0.3" reason="密码加密" />
        <package name="ioredis" version="^5.8.2" reason="Redis客户端 - 缓存" />
      </framework>
      <framework ecosystem="DevDependencies">
        <package name="prisma" version="^6.19.0" reason="数据库ORM工具" />
        <package name="@nuxtjs/tailwindcss" version="^6.14.0" reason="TailwindCSS集成" />
        <package name="tailwindcss" version="^3.4.18" reason="CSS框架" />
        <package name="vitest" version="^4.0.9" reason="测试框架" />
        <package name="@vitest/coverage-v8" version="^4.0.9" reason="测试覆盖率" />
        <package name="@vue/test-utils" version="^2.4.6" reason="Vue测试工具" />
        <package name="eslint" version="^9.39.1" reason="代码质量检查" />
        <package name="@antfu/eslint-config" version="^6.2.0" reason="ESLint配置" />
        <package name="prettier" version="^3.6.2" reason="代码格式化" />
        <package name="typescript" reason="类型检查" />
        <package name="tsx" version="^4.20.6" reason="TypeScript执行器" />
        <package name="husky" version="^9.1.7" reason="Git钩子管理" />
      </framework>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="docs/architecture.md#Implementation-Patterns">✅ 已遵循使用 Nuxt 4 + PrimeVue + Prisma + MySQL 技术栈</constraint>
    <constraint source="docs/architecture.md#API-Contracts">✅ 已实现API统一响应格式 {success, data, message, timestamp}，标准HTTP状态码</constraint>
    <constraint source="docs/architecture.md#Security-Architecture">✅ 已修复安全漏洞：所有会议室管理API已通过JWT + RBAC权限验证，使用room:create, room:read, room:update, room:delete权限</constraint>
    <constraint source="docs/architecture.md#数据验证模式">✅ 已实现使用Prisma数据验证 + Zod schema进行后端验证，FormKit进行前端表单验证</constraint>
    <constraint source="docs/architecture.md#缓存策略模式">待实现：多层缓存 - 浏览器缓存(1小时)，内存缓存(10分钟)，Redis缓存(10分钟)</constraint>
    <constraint source="docs/architecture.md#Error-Handling">✅ 已遵循统一错误处理模式，返回标准错误响应格式</constraint>
    <constraint source="existing-code">✅ 已复用现有的权限中间件requirePermission，集成到所有API</constraint>
    <constraint source="existing-code">✅ 已遵循现有的API路由结构：server/api/v1/rooms/ 下的标准RESTful端点</constraint>
    <constraint source="existing-code">✅ Vue组件已遵循现有的Composition API模式和响应式设计规范</constraint>
    <constraint source="docs/ux-design-specification.md#设计系统">✅ 已使用PrimeVue Styled Mode + Aura主题，企业商务蓝主色调</constraint>
    <constraint source="security-fix-2025-11-16">🔒 安全修复：修复用户ID记录问题，操作历史正确记录执行用户</constraint>
    <constraint source="security-fix-2025-11-16">🔒 安全修复：为文件上传API添加权限验证，确保只有具有room:update权限的用户可以上传文件</constraint>
  </constraints>
  <interfaces>
    <!-- ✅ 已实现的会议室管理API - 包含JWT认证和RBAC权限控制 -->
    <interface name="会议室管理API" kind="REST endpoints" signature="GET /api/v1/rooms - 获取会议室列表 (room:read权限)" path="server/api/v1/rooms/index.get.ts" />
    <interface name="会议室管理API" kind="REST endpoints" signature="POST /api/v1/rooms - 创建新会议室 (room:create权限)" path="server/api/v1/rooms/index.post.ts" />
    <interface name="会议室管理API" kind="REST endpoints" signature="GET /api/v1/rooms/:id - 获取单个会议室详情 (room:read权限)" path="server/api/v1/rooms/[id].get.ts" />
    <interface name="会议室管理API" kind="REST endpoints" signature="PUT /api/v1/rooms/:id - 更新会议室信息 (room:update权限)" path="server/api/v1/rooms/[id].put.ts" />
    <interface name="会议室管理API" kind="REST endpoints" signature="DELETE /api/v1/rooms/:id - 删除会议室 (room:delete权限)" path="server/api/v1/rooms/[id].delete.ts" />

    <!-- ✅ 已实现的文件上传API - 包含权限验证 -->
    <interface name="文件上传API" kind="REST endpoints" signature="POST /api/v1/upload/rooms - 会议室图片上传 (room:update权限)" path="server/api/v1/upload/rooms/post.ts" />

    <!-- ✅ 已实现的权限检查中间件 -->
    <interface name="权限检查" kind="middleware" signature="requirePermission(permission) - 检查具体权限" path="server/middleware/permission.ts" />

    <!-- ✅ 已实现的前端组件 -->
    <interface name="Vue组件" kind="component" signature="RoomManagement.vue - 会议室管理主界面" path="components/features/rooms/RoomManagement.vue" />
    <interface name="Vue组件" kind="component" signature="RoomCard.vue - 会议室卡片组件" path="components/features/rooms/RoomCard.vue" />
    <interface name="Vue组件" kind="component" signature="RoomForm.vue - 会议室编辑表单" path="components/features/rooms/RoomForm.vue" />

    <!-- ✅ 已实现的状态管理 -->
    <interface name="前端状态管理" kind="Pinia store" signature="stores/rooms.ts - 会议室状态管理" path="stores/rooms.ts" />
  </interfaces>
  <tests>
    <standards>使用 Vitest 测试框架 + Vue Test Utils 进行组件测试。测试结构包含单元测试、集成测试和API测试。遵循AAA模式(Arrange, Act, Assert)，使用test helpers生成测试数据，确保覆盖成功和失败场景，测试文件命名规范为 *.test.ts。</standards>
    <locations>
      <location pattern="tests/integration/api/rooms/*.test.ts" desc="API集成测试" />
      <location pattern="tests/unit/components/admin/*.test.ts" desc="Vue组件单元测试" />
      <location pattern="tests/unit/stores/*.test.ts" desc="Pinia状态管理测试" />
      <location pattern="test/helpers/api.ts" desc="API测试助手函数" />
      <location pattern="tests/setup.ts" desc="测试环境配置" />
    </locations>
    <ideas>
      <test idea="AC1 - 会议室基础数据管理API测试" acceptance_criteria="1">
        <test_case>GET /api/v1/rooms 返回会议室列表，包含分页和筛选</test_case>
        <test_case>POST /api/v1/rooms 创建新会议室，验证必填字段</test_case>
        <test_case>PUT /api/v1/rooms/:id 更新会议室信息</test_case>
        <test_case>DELETE /api/v1/rooms/:id 软删除会议室</test_case>
        <test_case>🔒 权限验证：未认证用户访问会议室管理API应返回401错误</test_case>
        <test_case>🔒 权限验证：无room:read权限用户访问GET API应返回403错误</test_case>
        <test_case>🔒 权限验证：无room:create权限用户访问POST API应返回403错误</test_case>
        <test_case>🔒 权限验证：无room:update权限用户访问PUT API应返回403错误</test_case>
        <test_case>🔒 权限验证：无room:delete权限用户访问DELETE API应返回403错误</test_case>
        <test_case>🔒 权限验证：文件上传API需要room:update权限</test_case>
      </test>
      <test idea="AC1 - 会议室状态管理测试" acceptance_criteria="1">
        <test_case>状态切换：AVAILABLE -> MAINTENANCE</test_case>
        <test_case>状态切换：MAINTENANCE -> AVAILABLE</test_case>
        <test_case>无效状态切换验证</test_case>
        <test_case>状态变更历史记录</test_case>
      </test>
      <test idea="AC1 - 前端组件测试" acceptance_criteria="1">
        <test_case>RoomManagement.vue 组件渲染和数据加载</test_case>
        <test_case>RoomForm.vue 表单验证和提交</test_case>
        <test_case>RoomCard.vue 会议室信息展示</test_case>
        <test_case>搜索和筛选功能</test_case>
        <test_case>批量操作：选择和删除多个会议室</test_case>
      </test>
      <test idea="AC1 - 文件上传测试" acceptance_criteria="1">
        <test_case>会议室图片上传API</test_case>
        <test_case>文件类型和大小验证</test_case>
        <test_case>文件存储路径和安全</test_case>
        <test_case>图片格式转换和压缩</test_case>
      </test>
        <test idea="AC1 - 文件上传测试" acceptance_criteria="1">
        <test_case>会议室图片上传API</test_case>
        <test_case>文件类型和大小验证</test_case>
        <test_case>文件存储路径和安全</test_case>
        <test_case>🔒 文件上传权限验证：需要room:update权限</test_case>
        <test_case>🔒 文件上传用户ID记录验证</test_case>
      </test>
    </ideas>
  </tests>

  <implementation-guidance>
    <optimization-needed>
      <item name="Redis缓存实现" priority="HIGH" description="会议室列表API需要实现Redis缓存，设置10分钟TTL，支持查询参数缓存键">
        <implementation>
          // 在server/utils/room-cache.ts中实现缓存管理器
          // 缓存键策略：rooms:list:{JSON.stringify(query)}
          // 缓存失效：创建/更新/删除会议室时清除相关缓存
          // 缓存预热：应用启动时预加载常用查询结果
        </implementation>
      </item>
      <item name="数据库索引优化" priority="HIGH" description="添加复合索引优化常用查询性能">
        <implementation>
          CREATE INDEX idx_meeting_rooms_status_location ON meeting_rooms(status, location);
          CREATE INDEX idx_meeting_rooms_search ON meeting_rooms(name, location, description);
          CREATE INDEX idx_meeting_rooms_deleted_name ON meeting_rooms(deletedAt, name);
        </implementation>
      </item>
      <item name="API限流保护" priority="MEDIUM" description="实现API请求频率限制，防止恶意调用">
        <implementation>
          // 基于用户ID和IP的限流策略
          // 管理员操作：100次/分钟
          // 普通用户：50次/分钟
          // 批量操作：10次/小时
        </implementation>
      </item>
    </optimization-needed>

    <security-enhancements>
      <item name="文件上传安全" priority="HIGH" description="增强文件上传功能的安全性">
        <implementation>
          // 文件类型白名单验证
          // 文件大小限制（5MB）
          // 文件名安全检查
          // 病毒扫描（可选）
        </implementation>
      </item>
      <item name="批量操作安全" priority="MEDIUM" description="加强批量操作的安全性控制">
        <implementation>
          // 批量操作权限验证
          // 操作频率限制
          // 数据量限制（单次最多100条）
          // 事务回滚机制
        </implementation>
      </item>
    </security-enhancements>

    <code-quality-improvements>
      <item name="服务层重构" priority="MEDIUM" description="将业务逻辑从API端点中提取到服务层">
        <implementation>
          // 创建server/services/room-service.ts
          // 实现RoomService类，包含所有业务逻辑
          // API端点只负责HTTP请求处理和响应格式化
        </implementation>
      </item>
      <item name="错误处理标准化" priority="MEDIUM" description="统一错误处理和用户友好的错误消息">
        <implementation>
          // 扩展现有的错误处理中间件
          // 定义标准错误码和错误消息
          // 实现错误日志记录和监控告警
        </implementation>
      </item>
    </code-quality-improvements>

    <performance-optimizations>
      <item name="前端性能优化" priority="MEDIUM" description="优化前端组件性能和用户体验">
        <implementation>
          // 实现虚拟滚动优化大量数据展示
          // 添加防抖搜索优化实时搜索体验
          // 实现图片懒加载和压缩优化
          // 优化组件渲染性能，减少不必要的重渲染
        </implementation>
      </item>
      <item name="数据库查询优化" priority="HIGH" description="优化数据库查询性能">
        <implementation>
          // 添加数据库连接池优化
          // 实现查询结果分页和懒加载
          // 优化复杂查询，使用N+1查询解决方案
          // 实现读写分离（如需要）
        </implementation>
      </item>
    </performance-optimizations>
  </implementation-guidance>
</story-context>