# Nuxt 3 API 单步调试完整指南

## 🎯 调试方法总结

基于您的会议室管理API，我已经为您配置了完整的调试环境。

## 1. 🚀 快速开始 (立即可用)

### 方法一：使用Debugger语句 (最简单)
```typescript
// 在任何API文件中添加debugger语句
export default defineEventHandler(async (event) => {
  debugger // 程序会在这里暂停
  const user = event.context.user
  // ...
})
```

### 方法二：使用Console日志
我已在 `server/api/v1/rooms/index.post.ts` 中添加了调试日志：
```typescript
console.log('🔍 Debug - 用户信息:', { user: event.context.user, userId })
console.log('🔍 Debug - 请求数据:', body)
console.log('🔍 Debug - 现有会议室检查结果:', existingRoom)
```

## 2. 🛠️ VS Code调试配置

已创建 `.vscode/launch.json` 文件，包含两种配置：

### 配置1：启动调试
```json
{
  "name": "Debug Nuxt Server",
  "type": "node",
  "request": "launch",
  "program": "${workspaceFolder}/node_modules/nuxi/bin/nuxi.mjs",
  "args": ["dev"]
}
```

**使用方法：**
1. 按 `F5` 或点击调试面板
2. 选择 "Debug Nuxt Server"
3. 在代码中点击行号左侧设置断点
4. 发送API请求，程序会在断点处暂停

### 配置2：附加调试
```json
{
  "name": "Debug Specific API",
  "type": "node",
  "request": "attach",
  "port": 9229
}
```

## 3. 📊 实际调试演示

### 当前状态：
- ✅ 服务器运行在: `http://localhost:3002`
- ✅ API路由正常工作
- ✅ 权限中间件正确拦截请求
- ✅ 调试代码已添加到 `rooms` API

### 测试结果：
```bash
📡 GET /api/v1/rooms -> 401 (未认证)
✅ 证明API和权限系统工作正常
```

## 4. 🔧 调试技巧

### 查看请求详情
```typescript
export default defineEventHandler(async (event) => {
  console.log('🔍 完整请求信息:', {
    method: event.node.req.method,
    url: event.node.req.url,
    headers: event.node.req.headers,
    query: getQuery(event),
    body: await readBody(event).catch(() => null)
  })
})
```

### 数据库查询调试
```typescript
// 在数据库操作前后添加日志
console.log('🔍 执行查询前:', { name: body.name })
const result = await prisma.meetingRoom.findMany({ where: conditions })
console.log('🔍 查询结果:', { count: result.length, data: result })
```

### 错误详细追踪
```typescript
try {
  // API逻辑
} catch (error) {
  console.error('🔍 错误详情:', {
    name: error.constructor.name,
    message: error.message,
    stack: error.stack,
    code: error.code,
    meta: error.meta
  })
  throw error
}
```

## 5. 🧪 测试工具

### 简单测试脚本
已创建 `simple-debug-test.js` 用于快速测试API：

```bash
node simple-debug-test.js
```

### cURL命令
```bash
# 测试GET请求
curl -X GET http://localhost:3002/api/v1/rooms -v

# 测试POST请求 (需要认证token)
curl -X POST http://localhost:3002/api/v1/rooms \
  -H "Content-Type: application/json" \
  -d '{"name":"测试会议室","capacity":10,"location":"1楼"}' \
  -v
```

## 6. 🔍 常见调试场景

### 场景1：API返回404
```typescript
// 检查文件路径和HTTP方法
console.log('🔍 API路径检查:', event.node.req.url)
console.log('🔍 HTTP方法:', event.node.req.method)
```

### 场景2：权限问题
```typescript
// 在权限中间件中添加调试
const user = event.context.user
console.log('🔍 用户认证状态:', {
  hasUser: !!user,
  userId: user?.id,
  userRole: user?.role
})
```

### 场景3：数据库连接
```typescript
// 测试数据库连接
try {
  await prisma.$queryRaw`SELECT 1`
  console.log('🔍 数据库连接正常')
} catch (error) {
  console.error('🔍 数据库连接失败:', error)
}
```

## 7. 📈 性能调试

### 添加性能计时
```typescript
const start = performance.now()
// 执行操作
const duration = performance.now() - start
console.log(`🔍 操作耗时: ${duration.toFixed(2)}ms`)
```

### 内存使用监控
```typescript
const memUsage = process.memoryUsage()
console.log('🔍 内存使用:', {
  rss: `${(memUsage.rss / 1024 / 1024).toFixed(2)}MB`,
  heapUsed: `${(memUsage.heapUsed / 1024 / 1024).toFixed(2)}MB`
})
```

## 8. 🎯 立即开始调试

### 步骤1：查看调试代码
检查 `server/api/v1/rooms/index.post.ts` 中的调试代码

### 步骤2：启动调试
```bash
# 方法A: VS Code调试
按 F5 -> 选择 "Debug Nuxt Server"

# 方法B: 命令行启动
npm run dev
```

### 步骤3：发送测试请求
```bash
node simple-debug-test.js
```

### 步骤4：查看调试输出
在服务器控制台查看带有 🔍 标记的调试信息

## 9. 💡 高级技巧

### 条件断点
在VS Code中设置条件断点，只在特定条件下暂停：
```javascript
// 条件：只在特定用户ID时暂停
user.id === 'your-target-user-id'
```

### 环境变量调试
```env
# .env 文件
DEBUG=api:*
LOG_LEVEL=debug
NODE_ENV=development
```

### Prisma查询日志
在 `nuxt.config.ts` 中添加：
```typescript
export default defineNuxtConfig({
  hooks: {
    'prisma:query': (e) => {
      console.log('🔍 DB查询:', e.query)
    }
  }
})
```

## ✅ 调试清单

- [ ] VS Code调试配置已就绪
- [ ] 调试代码已添加到关键API
- [ ] 测试脚本已创建
- [ ] 服务器正在运行
- [ ] 数据库连接正常
- [ ] 权限中间件工作正常

现在您可以使用任何上述方法来调试您的Nuxt 3 API了！