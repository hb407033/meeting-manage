import { Server as HTTPServer } from 'http'
import { Server as SocketIOServer } from 'socket.io'
import { availabilityCacheService } from '../services/availability-cache'

export default defineNuxtPlugin((nuxtApp) => {
  let io: SocketIOServer | null = null

  // åªåœ¨æœåŠ¡ç«¯åˆå§‹åŒ–Socket.IO
  if (process.server) {
    const httpServer = nuxtApp.nodeApp.server as HTTPServer

    io = new SocketIOServer(httpServer, {
      cors: {
        origin: process.env.NODE_ENV === 'production'
          ? process.env.ALLOWED_ORIGINS?.split(',') || []
          : ['http://localhost:3004', 'http://localhost:3000'],
        methods: ['GET', 'POST']
      },
      transports: ['websocket', 'polling']
    })

    // å­˜å‚¨ä¼šè®®å®¤é¢„çº¦çŠ¶æ€çš„å‘½åç©ºé—´
    const reservationNamespace = io.of('/reservations')

    reservationNamespace.on('connection', (socket) => {
      console.log('ç”¨æˆ·è¿žæŽ¥åˆ°é¢„çº¦å®žæ—¶æ›´æ–°:', socket.id)

      // åŠ å…¥ä¼šè®®å®¤ç‰¹å®šçš„æˆ¿é—´
      socket.on('join-room', (roomId: string) => {
        socket.join(`room-${roomId}`)
        console.log(`ç”¨æˆ· ${socket.id} åŠ å…¥ä¼šè®®å®¤ ${roomId}`)
      })

      // ç¦»å¼€ä¼šè®®å®¤æˆ¿é—´
      socket.on('leave-room', (roomId: string) => {
        socket.leave(`room-${roomId}`)
        console.log(`ç”¨æˆ· ${socket.id} ç¦»å¼€ä¼šè®®å®¤ ${roomId}`)
      })

      // å¤„ç†é¢„çº¦çŠ¶æ€å˜æ›´
      socket.on('reservation-change', async (data: {
        roomId: string
        action: 'created' | 'updated' | 'deleted'
        reservation?: any
      }) => {
        try {
          // ç«‹å³ä½¿ç›¸å…³ç¼“å­˜å¤±æ•ˆ
          await availabilityCacheService.invalidateRoomAvailability(data.roomId)

          // å‘è®¢é˜…è¯¥ä¼šè®®å®¤çš„æ‰€æœ‰ç”¨æˆ·å¹¿æ’­å˜æ›´
          socket.to(`room-${data.roomId}`).emit('reservation-updated', {
            roomId: data.roomId,
            action: data.action,
            reservation: data.reservation,
            timestamp: new Date().toISOString()
          })

          console.log(`ðŸ”„ é¢„çº¦å˜æ›´å·²å¤„ç†: ${data.action} for room ${data.roomId}`)
        } catch (error) {
          console.error('âŒ å¤„ç†é¢„çº¦å˜æ›´æ—¶å‡ºé”™:', error)

          // å³ä½¿ç¼“å­˜å¤±æ•ˆå¤±è´¥ï¼Œä¹Ÿè¦å¹¿æ’­é¢„çº¦å˜æ›´
          socket.to(`room-${data.roomId}`).emit('reservation-updated', {
            roomId: data.roomId,
            action: data.action,
            reservation: data.reservation,
            timestamp: new Date().toISOString(),
            error: 'ç¼“å­˜å¤±æ•ˆå¤±è´¥ï¼Œä½†é¢„çº¦çŠ¶æ€å·²æ›´æ–°'
          })
        }
      })

      socket.on('disconnect', () => {
        console.log('ç”¨æˆ·æ–­å¼€è¿žæŽ¥:', socket.id)
      })
    })

    // å…¨å±€å¹¿æ’­å‡½æ•°ï¼Œä¾›APIè°ƒç”¨
    nuxtApp.$broadcastReservationChange = async (data: {
      roomId: string
      action: 'created' | 'updated' | 'deleted'
      reservation?: any
    }) => {
      try {
        // ç«‹å³ä½¿ç›¸å…³ç¼“å­˜å¤±æ•ˆ
        await availabilityCacheService.invalidateRoomAvailability(data.roomId)

        if (reservationNamespace) {
          reservationNamespace.emit('reservation-updated', {
            roomId: data.roomId,
            action: data.action,
            reservation: data.reservation,
            timestamp: new Date().toISOString()
          })

          console.log(`ðŸ“¡ é¢„çº¦å˜æ›´å·²å¹¿æ’­: ${data.action} for room ${data.roomId}`)
        }
      } catch (error) {
        console.error('âŒ å¹¿æ’­é¢„çº¦å˜æ›´æ—¶å‡ºé”™:', error)

        // å³ä½¿ç¼“å­˜å¤±æ•ˆå¤±è´¥ï¼Œä¹Ÿè¦å¹¿æ’­é¢„çº¦å˜æ›´
        if (reservationNamespace) {
          reservationNamespace.emit('reservation-updated', {
            roomId: data.roomId,
            action: data.action,
            reservation: data.reservation,
            timestamp: new Date().toISOString(),
            error: 'ç¼“å­˜å¤±æ•ˆå¤±è´¥ï¼Œä½†é¢„çº¦çŠ¶æ€å·²æ›´æ–°'
          })
        }
      }
    }
  }

  return {
    provide: {
      socket: io
    }
  }
})

// æ‰©å±•NuxtAppç±»åž‹ä»¥åŒ…å«å¹¿æ’­å‡½æ•°
declare module '#app' {
  interface NuxtApp {
    $broadcastReservationChange: (data: {
      roomId: string
      action: 'created' | 'updated' | 'deleted'
      reservation?: any
    }) => void
  }
}