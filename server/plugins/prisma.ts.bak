import { PrismaClient } from '@prisma/client'

let prisma: PrismaClient

export default defineNuxtPlugin((nuxtApp) => {
  if (!prisma) {
    prisma = new PrismaClient({
      log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
    })
  }

  // 在开发环境中启用热重载
  if (process.dev) {
    nuxtApp.hook('app:destroyed', async () => {
      await prisma.$disconnect()
    })
  }

  nuxtApp.$prisma = prisma

  return {
    provide: {
      prisma
    }
  }
})

declare module '#app' {
  interface NuxtApp {
    $prisma: PrismaClient
  }
}

declare module 'vue' {
  interface ComponentCustomProperties {
    $prisma: PrismaClient
  }
}