/**
 * å¼€å‘ç¯å¢ƒè‡ªåŠ¨ç™»å½•ä¸­é—´ä»¶
 * ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹å¯ç”¨ï¼Œä¸ºå¼€å‘è€…æä¾›è‡ªåŠ¨ç™»å½•åŠŸèƒ½
 */

import { isDevAutoLoginEnabled, isDevAutoLoginSafe, getDevUserConfig } from '~~/server/utils/environment'
import { generateTokenPair } from '~~/server/utils/jwt'
import { ensureDevUserExists, validateDevUserPermissions } from '~~/server/services/dev-user-service'

export default defineEventHandler(async (event) => {
  // åªå¤„ç†APIè¯·æ±‚
  if (!event.node.req.url?.startsWith('/api/')) {
    return
  }

  // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯ç›¸å…³APIï¼Œè·³è¿‡è‡ªåŠ¨ç™»å½•é€»è¾‘é¿å…æ— é™å¾ªç¯
  const authUrls = ['/api/v1/auth/login', '/api/v1/auth/register', '/api/v1/auth/logout']
  if (authUrls.some(url => event.node.req.url?.includes(url))) {
    return
  }

  // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹å¯ç”¨
  if (!isDevAutoLoginEnabled() || !isDevAutoLoginSafe()) {
    return
  }

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•
  const existingToken = getCookie(event, 'auth_token')
  if (existingToken) {
    try {
      // éªŒè¯ç°æœ‰token
      const jwt = await import('jsonwebtoken')
      jwt.verify(existingToken, process.env.JWT_SECRET!)
      return // Tokenæœ‰æ•ˆï¼Œæ— éœ€è‡ªåŠ¨ç™»å½•
    } catch {
      // Tokenæ— æ•ˆï¼Œç»§ç»­è‡ªåŠ¨ç™»å½•æµç¨‹
    }
  }

  try {
    // è·å–å¼€å‘ç”¨æˆ·é…ç½®
    const devUserConfig = getDevUserConfig()

    // ç¡®ä¿å¼€å‘ç”¨æˆ·å­˜åœ¨
    const devUser = await ensureDevUserExists()
    if (!devUser) {
      console.error('å¼€å‘ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼Œè·³è¿‡è‡ªåŠ¨ç™»å½•')
      return
    }

    // éªŒè¯å¼€å‘ç”¨æˆ·æƒé™
    const hasPermissions = await validateDevUserPermissions(devUser)
    if (!hasPermissions) {
      console.error('å¼€å‘ç”¨æˆ·æƒé™éªŒè¯å¤±è´¥ï¼Œè·³è¿‡è‡ªåŠ¨ç™»å½•')
      return
    }

    // è·å–å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«æƒé™ï¼‰
    const user = await prisma.user.findUnique({
      where: { id: devUser.id },
      include: {
        userRoles: {
          include: {
            role: {
              include: {
                rolePermissions: {
                  include: {
                    permission: true
                  }
                }
              }
            }
          }
        }
      }
    })

    if (!user) {
      console.error('æ— æ³•æ‰¾åˆ°å¼€å‘ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è¿‡è‡ªåŠ¨ç™»å½•')
      return
    }

    // æå–æƒé™åˆ—è¡¨
    const permissions = user.userRoles.flatMap(ur =>
      ur.role.rolePermissions.map(rp => rp.permission.code)
    )

    // ç”ŸæˆJWT token
    const tokens = generateTokenPair({
      userId: user.id,
      email: user.email,
      roles: user.userRoles.map(ur => ur.role.name),
      permissions
    })

    // è®¾ç½®cookie
    setCookie(event, 'auth_token', tokens.accessToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 60 * 60 // 1å°æ—¶
    })

    setCookie(event, 'refresh_token', tokens.refreshToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 7 * 24 * 60 * 60 // 7å¤©
    })

    // æ›´æ–°ç”¨æˆ·æœ€åç™»å½•ä¿¡æ¯
    await prisma.user.update({
      where: { id: user.id },
      data: {
        lastLoginAt: new Date(),
        lastLoginIP: getClientIP(event) || 'unknown'
      }
    })

    // åœ¨å¼€å‘ç¯å¢ƒä¸‹è¾“å‡ºæ—¥å¿—
    if (process.env.NODE_ENV === 'development') {
      console.log(`ğŸ”§ Dev Auto Login: è‡ªåŠ¨ç™»å½•ç”¨æˆ· ${devUserConfig.email}`)
      console.log(`ğŸ“‹ è§’è‰²: ${user.userRoles.map(ur => ur.role.name).join(', ')}`)
      console.log(`ğŸ”‘ æƒé™æ•°é‡: ${permissions.length}`)
    }

  } catch (error) {
    console.error('å¼€å‘ç¯å¢ƒè‡ªåŠ¨ç™»å½•å¤±è´¥:', error)
    // è‡ªåŠ¨ç™»å½•å¤±è´¥ä¸åº”è¯¥å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œé™é»˜å¤„ç†
  }
})

